<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>üì∂ Wi-Fi Realtime Monitoring</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <!-- Zoom Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 20px;
        background: #f5f7fa;
        color: #333;
      }

      h2 {
        text-align: center;
        margin-bottom: 10px;
      }

      a {
        color: #007bff;
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      .chart-container {
        display: flex;
        flex-direction: column;
        gap: 30px;
        max-width: 1000px;
        margin: auto;
      }

      canvas {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 10px;
      }

      @media (min-width: 768px) {
        .chart-container {
          flex-direction: row;
          justify-content: space-between;
        }

        canvas {
          width: 48% !important;
          height: auto !important;
        }
      }

      #ssidList {
        text-align: center;
        margin-top: 20px;
        font-size: 16px;
      }

      #ssidList a {
        margin: 0 8px;
      }

      #resetZoomBtn {
        display: block;
        margin: 20px auto;
        padding: 8px 16px;
        font-size: 14px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      #resetZoomBtn:hover {
        background-color: #0056b3;
      }
    </style>
  </head>

  <body>
    <h2>üì∂ Wi-Fi Realtime Monitoring (‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</h2>
    <a href="/history.html" style="display: block; text-align: center; margin-bottom: 20px;">‡∏î‡∏π‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</a>

    <div class="chart-container">
      <canvas id="signalChart"></canvas>
      <canvas id="qualityChart"></canvas>
    </div>

    <button id="resetZoomBtn" onclick="resetZoom()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°</button>

    <div id="ssidList"><strong>üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î SSID...</strong></div>

    <script>
      const signalCtx = document.getElementById("signalChart").getContext("2d");
      const qualityCtx = document.getElementById("qualityChart").getContext("2d");
      const ssidList = document.getElementById("ssidList");

      let signalChart, qualityChart;
      const chartSyncGroup = "wifiSync";

      function resetZoom() {
        if (signalChart) signalChart.resetZoom();
        if (qualityChart) qualityChart.resetZoom();
      }

      async function fetchAndRender() {
        try {
          const res = await fetch("/api/realtime");
          const data = await res.json();

          const ssids = [...new Set(data.map((d) => d.ssid))];
          ssidList.innerHTML =
            `<strong>üîç ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î SSID:</strong><br>` +
            ssids
              .map((ssid) => {
                const safeName = ssid || "[‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠]";
                return `<a href="/ssid.html?name=${encodeURIComponent(ssid)}" target="_blank">${safeName}</a>`;
              })
              .join("");

          const genDataset = (field) =>
            ssids.map((ssid) => ({
              label: ssid || "[‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠]",
              data: data
                .filter((d) => d.ssid === ssid)
                .map((d) => ({
                  x: new Date(d.timestamp),
                  y: d[field],
                })),
              borderColor: `hsl(${Math.random() * 360}, 70%, 50%)`,
              tension: 0.3,
              fill: false,
            }));

          if (signalChart) signalChart.destroy();
          if (qualityChart) qualityChart.destroy();

          const commonOptions = {
            responsive: true,
            animation: false,
            interaction: { mode: "nearest", intersect: false },
            plugins: {
              title: { display: true },
              legend: { position: "bottom" },
              zoom: {
                pan: {
                  enabled: true,
                  mode: "x",
                  sync: {
                    enabled: true,
                    group: chartSyncGroup,
                  },
                },
                zoom: {
                  wheel: { enabled: true },
                  pinch: { enabled: true },
                  mode: "x",
                  sync: {
                    enabled: true,
                    group: chartSyncGroup,
                  },
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const time = new Date(context.parsed.x).toLocaleTimeString("th-TH", {
                      hour: "2-digit",
                      minute: "2-digit",
                      second: "2-digit",
                    });
                    return `${context.dataset.label}: ${context.parsed.y} (‡πÄ‡∏ß‡∏•‡∏≤ ${time})`;
                  },
                },
              },
            },
            scales: {
              x: {
                type: "time",
                time: {
                  unit: "minute",
                  tooltipFormat: "HH:mm:ss",
                  displayFormats: {
                    minute: "HH:mm",
                    hour: "HH:mm",
                  },
                },
                title: { display: true, text: "‡πÄ‡∏ß‡∏•‡∏≤" },
              },
              y: {
                beginAtZero: false,
              },
            },
          };

          signalChart = new Chart(signalCtx, {
            type: "line",
            data: { datasets: genDataset("signal_level") },
            options: {
              ...commonOptions,
              plugins: {
                ...commonOptions.plugins,
                title: { text: "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì (dBm)" },
              },
              scales: {
                ...commonOptions.scales,
                y: {
                  ...commonOptions.scales.y,
                  suggestedMin: -100,
                  suggestedMax: 0,
                  title: { display: true, text: "Signal (dBm)" },
                },
              },
            },
          });

          qualityChart = new Chart(qualityCtx, {
            type: "line",
            data: { datasets: genDataset("quality") },
            options: {
              ...commonOptions,
              plugins: {
                ...commonOptions.plugins,
                title: { text: "‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì (%)" },
              },
              scales: {
                ...commonOptions.scales,
                y: {
                  ...commonOptions.scales.y,
                  suggestedMin: 0,
                  suggestedMax: 100,
                  title: { display: true, text: "Quality (%)" },
                },
              },
            },
          });
        } catch (error) {
          ssidList.innerHTML = `<strong style="color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</strong>`;
          console.error(error);
        }
      }

      setInterval(fetchAndRender, 5000);
      fetchAndRender();
    </script>
  </body>
</html>

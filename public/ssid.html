<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î SSID</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: sans-serif;
      background: #f9f9f9;
    }

    #container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      box-sizing: border-box;
      padding: 20px;
    }

    h2 {
      margin: 0 0 10px;
      text-align: center;
    }

    a {
      display: block;
      margin-bottom: 20px;
      color: #007bff;
      text-decoration: none;
      text-align: center;
    }

    #combinedChart {
      flex-grow: 1;
      width: 100%;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    #resetZoomBtn {
      margin: 10px auto 0;
      padding: 8px 16px;
      font-size: 14px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #resetZoomBtn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div id="container">
    <h2 id="title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î SSID</h2>
    <a href="/index.html">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>

    <canvas id="combinedChart"></canvas>
    <button id="resetZoomBtn" onclick="resetZoom()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°</button>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const ssid = urlParams.get('name');

    if (!ssid) {
      alert('‡πÑ‡∏°‡πà‡∏û‡∏ö SSID ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô URL');
    }

    document.getElementById('title').textContent = `üì° ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${ssid}`;

    const ctx = document.getElementById('combinedChart').getContext('2d');
    let combinedChart;

    function resetZoom() {
      if (combinedChart) combinedChart.resetZoom();
    }

    async function loadData() {
      const res = await fetch('/api/realtime');
      const allData = await res.json();
      const data = allData.filter(d => d.ssid === ssid);

      if (data.length === 0) return;

      const signalData = data.map(d => ({
        x: new Date(d.timestamp),
        y: d.signal_level
      }));

      const qualityData = data.map(d => ({
        x: new Date(d.timestamp),
        y: d.quality
      }));

      if (combinedChart) combinedChart.destroy();

      combinedChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [
            {
              label: 'Signal Level (dBm)',
              data: signalData,
              borderColor: 'blue',
              yAxisID: 'ySignal',
              tension: 0.3
            },
            {
              label: 'Quality (%)',
              data: qualityData,
              borderColor: 'green',
              yAxisID: 'yQuality',
              tension: 0.3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: { position: 'bottom' },
            zoom: {
              pan: {
                enabled: true,
                mode: 'x'
              },
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                mode: 'x'
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function (context) {
                  const time = new Date(context.parsed.x).toLocaleTimeString("th-TH", {
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit"
                  });
                  return `${context.dataset.label}: ${context.parsed.y} (‡πÄ‡∏ß‡∏•‡∏≤ ${time})`;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              grid: {
                drawOnChartArea: true
              },
              time: {
                unit: 'minute',
                tooltipFormat: 'HH:mm:ss',
                displayFormats: {
                  minute: 'HH:mm',
                  hour: 'HH:mm'
                }
              },
              title: { display: true, text: '‡πÄ‡∏ß‡∏•‡∏≤' }
            },
            ySignal: {
              position: 'left',
              suggestedMin: -100,
              suggestedMax: 0,
              title: { display: true, text: 'Signal (dBm)' }
            },
            yQuality: {
              position: 'right',
              suggestedMin: 0,
              suggestedMax: 100,
              title: { display: true, text: 'Quality (%)' },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
    }

    loadData();
    setInterval(loadData, 5000);
  </script>
</body>
</html>
